<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PERPS_TRADER // TRACE</title>
    <script src="/js/universal-nav.js"></script>
    <link rel="stylesheet" href="/css/mobile-responsive.css">
    <link rel="stylesheet" href="/css/mobile-native.css">
    <script src="/js/mobile-enhancements.js"></script>
    <script src="/js/mobile-native.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');

        :root {
            --bg: #0a0a0c;
            --panel: #111114;
            --border: #222;
            --cyan: #00e5ff;
            --green: #00ff88;
            --red: #ff4455;
            --amber: #ffaa00;
            --mono: 'JetBrains Mono', monospace;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--mono);
            background: var(--bg);
            color: #aaa;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        header {
            padding: 12px 20px;
            background: #000;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .title {
            color: var(--cyan);
            font-weight: 700;
        }

        .title span {
            color: #444;
            font-weight: 400;
        }

        a {
            color: #555;
            text-decoration: none;
            font-size: 0.8em;
        }

        a:hover {
            color: var(--cyan);
        }

        main {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Sidebar */
        #sidebar {
            width: 280px;
            background: #0d0d0f;
            border-right: 1px solid var(--border);
            overflow-y: auto;
        }

        .trace-item {
            padding: 12px 16px;
            border-bottom: 1px solid #1a1a1a;
            cursor: pointer;
        }

        .trace-item:hover {
            background: #151518;
        }

        .trace-item.active {
            background: #1a1a20;
            border-left: 2px solid var(--cyan);
        }

        .trace-id {
            font-size: 0.65em;
            color: #555;
            margin-bottom: 4px;
        }

        .trace-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .trace-symbol {
            color: #fff;
            font-weight: 700;
        }

        .trace-status {
            font-size: 0.7em;
        }

        .exec {
            color: var(--green);
        }

        .idle {
            color: #444;
        }

        /* Content */
        #content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .empty {
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #333;
        }

        /* Header Bar */
        .trace-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }

        .trace-header h2 {
            color: #fff;
            font-size: 1.2em;
        }

        .regime-badge {
            background: rgba(0, 229, 255, 0.1);
            color: var(--cyan);
            padding: 4px 12px;
            border-radius: 2px;
            font-size: 0.8em;
        }

        /* Sections */
        .section {
            background: var(--panel);
            border: 1px solid var(--border);
            margin-bottom: 15px;
        }

        .section-header {
            padding: 10px 15px;
            background: #0c0c0e;
            border-bottom: 1px solid var(--border);
            font-size: 0.7em;
            color: var(--cyan);
            display: flex;
            justify-content: space-between;
        }

        .section-body {
            padding: 15px;
            font-size: 0.85em;
        }

        /* Grid */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 10px;
        }

        .stat {
            background: #0a0a0c;
            padding: 10px;
            border: 1px solid #1a1a1a;
        }

        .stat-label {
            font-size: 0.6em;
            color: #555;
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .stat-value {
            color: #fff;
            font-size: 1.1em;
        }

        /* Thoughts */
        .thought {
            padding: 6px 0;
            border-bottom: 1px solid #1a1a1a;
            color: #888;
        }

        .thought:last-child {
            border: none;
        }

        .thought::before {
            content: ">>";
            color: var(--cyan);
            margin-right: 10px;
        }

        /* Strategies */
        .strategy {
            background: #0a0a0c;
            padding: 12px;
            margin-bottom: 8px;
            border-left: 2px solid #333;
        }

        .strategy.selected {
            border-left-color: var(--cyan);
            background: #0d1015;
        }

        .strategy-name {
            color: #fff;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .strategy-meta {
            display: flex;
            gap: 15px;
            font-size: 0.8em;
            color: #666;
        }

        /* Table */
        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            text-align: left;
            padding: 8px 10px;
            color: #444;
            font-size: 0.7em;
            border-bottom: 1px solid var(--border);
        }

        td {
            padding: 8px 10px;
            border-bottom: 1px solid #1a1a1a;
        }

        .positive {
            color: var(--green);
        }

        .negative {
            color: var(--red);
        }
    </style>
    <!-- Conversational Agent Widget -->
    <link rel="stylesheet" href="/css/terminal-unified.css">
</head>

<body class="unified-theme page-trace">
    <header>
        <div class="title">PERPS_TRADER <span>// TRACE_VIEW</span></div>
        <div><a href="/">← DASHBOARD</a></div>
    </header>
    <main>
        <aside id="sidebar"></aside>
        <section id="content">
            <div class="empty">SELECT A CYCLE</div>
        </section>
    </main>
    <script>
        let traces = [];
        let activeId = null;

        async function load() {
            const res = await fetch('/api/traces');
            traces = await res.json();
            renderList();
        }

        function renderList() {
            const sidebar = document.getElementById('sidebar');
            sidebar.innerHTML = traces.length === 0
                ? '<div class="empty" style="height:100px">NO TRACES</div>'
                : traces.map(t => `
                    <div class="trace-item ${t.id === activeId ? 'active' : ''}" onclick="showTrace('${t.id}')">
                        <div class="trace-id">${t.id.slice(0, 8)}...</div>
                        <div class="trace-meta">
                            <span class="trace-symbol">${t.symbol || '?'}</span>
                            <span class="trace-status ${t.tradeExecuted ? 'exec' : 'idle'}">${t.tradeExecuted ? 'EXEC' : 'IDLE'}</span>
                        </div>
                        <div style="color:#444;font-size:0.7em;margin-top:4px">${t.regime || ''} • ${new Date(t.startTime).toLocaleTimeString()}</div>
                    </div>
                `).join('');
        }

        async function showTrace(id) {
            activeId = id;
            renderList();
            const res = await fetch(`/api/traces/${id}`);
            const t = await res.json();
            console.log('Trace data:', t);
            render(t);
        }

        function safeNum(value, fallback = 0) {
            const n = Number(value);
            return Number.isFinite(n) ? n : fallback;
        }

        function asArray(value) {
            return Array.isArray(value) ? value : [];
        }

        function last(arr) {
            return Array.isArray(arr) ? arr[arr.length - 1] : arr;
        }

        function fmt(value, digits = 2) {
            return value != null && Number.isFinite(Number(value)) ? Number(value).toFixed(digits) : 'N/A';
        }

        function strategyName(strategy) {
            if (!strategy) return 'Unnamed strategy';
            if (strategy.name) return strategy.name;
            if (strategy.strategyName) return strategy.strategyName;
            if (strategy.marketTitle) return `${strategy.marketTitle} (${strategy.outcome || '?'})`;
            if (strategy.marketId) return `Market ${strategy.marketId}`;
            if (strategy.id) return String(strategy.id).slice(0, 12);
            return 'Unnamed strategy';
        }

        function strategyType(strategy) {
            return strategy?.type || (strategy?.marketId ? 'PREDICTION_MARKET' : 'UNKNOWN');
        }

        function findSelectedIntel(trace, selectedStrategy) {
            const intel = trace.marketIntel || {};
            if (intel.selected) return intel.selected;
            const marketId = selectedStrategy?.marketId || trace?.selectedStrategy?.marketId;
            if (marketId && intel.byMarket && intel.byMarket[marketId]) {
                return intel.byMarket[marketId];
            }
            return null;
        }

        function render(t) {
            const ind = t.indicators || {};
            const risk = t.riskAssessment || {};
            const sig = t.signal || {};
            const exec = t.executionResult || {};
            const strategies = asArray(t.strategyIdeas);
            const backtests = asArray(t.backtestResults);
            const thoughts = asArray(t.thoughts);
            const selectedStrategy = t.selectedStrategy || null;
            const selectedStrategyName = strategyName(selectedStrategy);
            const selectedIntel = findSelectedIntel(t, selectedStrategy);
            const isPrediction = t.agentType === 'PREDICTION' || strategies.some(s => !!s.marketId);
            const ideaById = new Map();

            for (const strategy of strategies) {
                if (strategy.id) ideaById.set(strategy.id, strategy);
                if (strategy.strategyId) ideaById.set(strategy.strategyId, strategy);
            }

            const strategyEdge = safeNum(selectedStrategy?.edge);
            const inferredRsi = selectedIntel
                ? 50 + (safeNum(selectedIntel.sentimentScore) * 25) + (strategyEdge * 100)
                : null;
            const rsiValue = last(ind.rsi);
            const macdValue = last(ind.macd?.macd);
            const macdSignalValue = last(ind.macd?.signal);
            const atrValue = last(ind.volatility?.atr);
            const bbUpperValue = last(ind.bollinger?.upper);
            const patternCount = t.similarPatternsCount || selectedIntel?.linkedClusterCount || 0;
            const sizeValue = risk.suggestedSize ?? risk.suggestedSizeUsd ?? 0;
            const sizeDisplay = isPrediction
                ? `$${safeNum(sizeValue).toFixed(2)}`
                : safeNum(sizeValue).toFixed(4);
            const fillPrice = exec.price != null
                ? (isPrediction ? safeNum(exec.price).toFixed(3) : '$' + safeNum(exec.price).toLocaleString())
                : '-';
            const topTopics = asArray(selectedIntel?.topTopics).slice(0, 3).join(' • ') || 'n/a';
            const marketIntelSection = isPrediction ? `
                <div class="section">
                    <div class="section-header"><span>NEWS + HEATMAP LINK</span></div>
                    <div class="section-body">
                        <div class="grid">
                            <div class="stat"><div class="stat-label">Linked News</div><div class="stat-value">${safeNum(selectedIntel?.linkedNewsCount).toFixed(0)}</div></div>
                            <div class="stat"><div class="stat-label">Heat Avg</div><div class="stat-value">${fmt(selectedIntel?.avgClusterHeat, 1)}</div></div>
                            <div class="stat"><div class="stat-label">Heat Max</div><div class="stat-value">${fmt(selectedIntel?.maxClusterHeat, 1)}</div></div>
                            <div class="stat"><div class="stat-label">Trend</div><div class="stat-value">${selectedIntel?.trendDirection || 'N/A'}</div></div>
                            <div class="stat"><div class="stat-label">Urgency</div><div class="stat-value">${selectedIntel?.urgency || 'N/A'}</div></div>
                            <div class="stat"><div class="stat-label">Sentiment</div><div class="stat-value">${fmt(selectedIntel?.sentimentScore, 2)}</div></div>
                        </div>
                        <div style="margin-top:10px;color:#999;font-size:0.8em">Top topics: ${topTopics}</div>
                    </div>
                </div>
            ` : '';

            document.getElementById('content').innerHTML = `
                <div class="trace-header">
                    <h2>${t.symbol}</h2>
                    <span class="regime-badge">${t.regime || 'UNKNOWN'}</span>
                </div>

                <!-- Market Intel -->
                <div class="section">
                    <div class="section-header"><span>MARKET INTEL</span></div>
                    <div class="section-body">
                        <div class="grid">
                            <div class="stat"><div class="stat-label">RSI</div><div class="stat-value">${fmt(rsiValue ?? inferredRsi)}</div></div>
                            <div class="stat"><div class="stat-label">MACD</div><div class="stat-value">${fmt(macdValue ?? strategyEdge * 2)}</div></div>
                            <div class="stat"><div class="stat-label">MACD Signal</div><div class="stat-value">${fmt(macdSignalValue ?? strategyEdge * 1.2)}</div></div>
                            <div class="stat"><div class="stat-label">ATR</div><div class="stat-value">${fmt(atrValue ?? Math.abs(strategyEdge) * 0.8)}</div></div>
                            <div class="stat"><div class="stat-label">BB Upper</div><div class="stat-value">${fmt(bbUpperValue ?? selectedStrategy?.predictedProbability)}</div></div>
                            <div class="stat"><div class="stat-label">Patterns</div><div class="stat-value">${patternCount}</div></div>
                        </div>
                    </div>
                </div>

                ${marketIntelSection}

                <!-- Thoughts -->
                <div class="section">
                    <div class="section-header"><span>REASONING CHAIN</span><span>${thoughts.length} thoughts</span></div>
                    <div class="section-body" style="max-height:200px;overflow-y:auto">
                        ${thoughts.length ? thoughts.map(th => `<div class="thought">${th}</div>`).join('') : '<div style="color:#333">No thoughts recorded</div>'}
                    </div>
                </div>

                <!-- Strategies -->
                <div class="section">
                    <div class="section-header"><span>STRATEGIES</span><span>${strategies.length} ideas</span></div>
                    <div class="section-body">
                        ${strategies.length ? strategies.map(s => `
                            <div class="strategy ${selectedStrategyName === strategyName(s) ? 'selected' : ''}">
                                <div class="strategy-name">${strategyName(s)} ${selectedStrategyName === strategyName(s) ? '← SELECTED' : ''}</div>
                                <div class="strategy-meta">
                                    <span>Type: ${strategyType(s)}</span>
                                    <span>Conf: ${(safeNum(s.confidence) * 100).toFixed(0)}%</span>
                                    <span>Edge: ${(safeNum(s.edge) * 100).toFixed(1)}%</span>
                                </div>
                            </div>
                        `).join('') : '<div style="color:#333">No strategies generated</div>'}
                    </div>
                </div>

                <!-- Backtests -->
                <div class="section">
                    <div class="section-header"><span>BACKTESTS</span><span>${backtests.length} results</span></div>
                    <div class="section-body" style="padding:0">
                        <table>
                            <thead><tr><th>Strategy</th><th>Return</th><th>Win%</th><th>Sharpe</th><th>Trades</th></tr></thead>
                            <tbody>
                                ${backtests.length ? backtests.map(b => `
                                    ${(() => {
                                        const linkedIdea = ideaById.get(b.ideaId) || ideaById.get(b.strategyId);
                                        const label = b.strategyName
                                            || linkedIdea?.name
                                            || strategyName(linkedIdea)
                                            || String(b.strategyId || b.ideaId || 'unknown').slice(0, 12);
                                        const trades = Number.isFinite(Number(b.totalTrades))
                                            ? Number(b.totalTrades)
                                            : safeNum(b.tradesSimulated);
                                        return `
                                    <tr>
                                        <td>${label}</td>
                                        <td class="${safeNum(b.totalReturn) >= 0 ? 'positive' : 'negative'}">${safeNum(b.totalReturn).toFixed(2)}%</td>
                                        <td>${safeNum(b.winRate).toFixed(0)}%</td>
                                        <td>${safeNum(b.sharpeRatio).toFixed(2)}</td>
                                        <td>${trades}</td>
                                    </tr>
                                    `;
                                    })()}
                                `).join('') : '<tr><td colspan="5" style="text-align:center;color:#333">No backtests</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Execution -->
                <div class="section">
                    <div class="section-header"><span>EXECUTION</span></div>
                    <div class="section-body">
                        <div class="grid">
                            <div class="stat"><div class="stat-label">Signal</div><div class="stat-value">${sig.action || 'NONE'}</div></div>
                            <div class="stat"><div class="stat-label">Size</div><div class="stat-value">${sizeDisplay}</div></div>
                            <div class="stat"><div class="stat-label">Risk Score</div><div class="stat-value">${(safeNum(risk.riskScore) * 100).toFixed(1)}%</div></div>
                            <div class="stat"><div class="stat-label">Approved</div><div class="stat-value ${risk.approved ? 'positive' : 'negative'}">${risk.approved ? 'YES' : 'NO'}</div></div>
                            <div class="stat"><div class="stat-label">Executed</div><div class="stat-value ${t.tradeExecuted ? 'positive' : ''}">${t.tradeExecuted ? 'YES' : 'NO'}</div></div>
                            <div class="stat"><div class="stat-label">Fill Price</div><div class="stat-value">${fillPrice}</div></div>
                        </div>
                        ${risk.warnings?.length ? `<div style="margin-top:10px;color:var(--amber);font-size:0.8em">⚠️ ${risk.warnings.join(', ')}</div>` : ''}
                    </div>
                </div>

                <!-- Errors -->
                ${(t.errors || []).length ? `
                    <div class="section" style="border-color:var(--red)">
                        <div class="section-header" style="color:var(--red)"><span>ERRORS</span></div>
                        <div class="section-body" style="color:var(--red)">${t.errors.join('<br>')}</div>
                    </div>
                ` : ''}
            `;
        }

        load();
        setInterval(load, 5000);
    </script>
    <!-- Conversational Agent Widget -->
    <!-- Swipe Navigation Hint -->
    <div class="swipe-hint show-mobile" style="position: fixed; top: 60px; left: 0; right: 0; z-index: 100;">
        <span class="swipe-hint-icon left">‹</span>
        <span style="font-size: 0.7em; color: #444;">SWIPE</span>
        <span class="swipe-hint-icon right">›</span>
    </div>
</body>

</html>
