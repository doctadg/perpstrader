#!/bin/bash

# PerpsTrader Control Script

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Function to print colored output
print_status() {
    local color=$1
    local message=$2
    echo -e "${color}${message}${NC}"
}

# Function to check if service is running
check_service() {
    local service=$1
    if systemctl is-active --quiet "$service"; then
        echo -e "${GREEN}RUNNING${NC}"
    else
        echo -e "${RED}STOPPED${NC}"
    fi
}

# Function to show service status
show_status() {
    print_status $BLUE "üîç PerpsTrader Service Status"
    echo "=================================="
    printf "%-20s %s\n" "Service" "Status"
    printf "%-20s %s\n" "--------" "------"
    printf "%-20s %s\n" "perps-redis" "$(check_service perps-redis)"
    printf "%-20s %s\n" "chromadb" "$(check_service chromadb)"
    printf "%-20s %s\n" "perps-agent" "$(check_service perps-agent)"
    printf "%-20s %s\n" "perps-ingester" "$(check_service perps-ingester)"
    printf "%-20s %s\n" "perps-news" "$(check_service perps-news)"
    printf "%-20s %s\n" "perps-predictions" "$(check_service perps-predictions)"
    printf "%-20s %s\n" "perps-dashboard" "$(check_service perps-dashboard)"
    printf "%-20s %s\n" "perps-news-worker" "$(check_service perps-news-worker)"
    printf "%-20s %s\n" "perps-pumpfun" "$(check_service perps-pumpfun)"
    printf "%-20s %s\n" "perps-safekeeping" "$(check_service perps-safekeeping)"
    printf "%-20s %s\n" "perps-research" "$(check_service perps-research)"
    echo ""

    # Show dashboard URL if running
    if systemctl is-active --quiet perps-dashboard; then
        print_status $GREEN "üåê Dashboard: http://0.0.0.0:3001 (accessible across your network)"
    fi
}

# Function to show enhanced clustering status
show_enhanced_status() {
    print_status $BLUE "üöÄ Enhanced Clustering Status"
    echo "====================================="

    # Load .env file if it exists
    local env_file="$PROJECT_DIR/.env"
    if [ -f "$env_file" ]; then
        source "$env_file"
    fi

    # Check enhancement status
    local enhanced_mode="${USE_ENHANCED_CLUSTERING:-false}"
    if [ "$enhanced_mode" = "true" ]; then
        print_status $GREEN "‚úì Enhanced Clustering: ENABLED"
    else
        print_status $YELLOW "‚óã Enhanced Clustering: DISABLED (using standard mode)"
    fi

    echo ""
    echo "Enhancement Toggles:"

    if [ "$enhanced_mode" = "true" ]; then
        [ "${ENABLE_ENTITY_EXTRACTION:-false}" = "true" ] && \
            print_status $GREEN "  ‚úì Entity Extraction" || \
            print_status $YELLOW "  ‚óã Entity Extraction"

        [ "${ENABLE_ANOMALY_DETECTION:-false}" = "true" ] && \
            print_status $GREEN "  ‚úì Anomaly Detection" || \
            print_status $YELLOW "  ‚óã Anomaly Detection"

        [ "${ENABLE_HEAT_PREDICTION:-false}" = "true" ] && \
            print_status $GREEN "  ‚úì Heat Prediction" || \
            print_status $YELLOW "  ‚óã Heat Prediction"

        [ "${ENABLE_CROSS_CATEGORY_LINKING:-false}" = "true" ] && \
            print_status $GREEN "  ‚úì Cross-Category Linking" || \
            print_status $YELLOW "  ‚óã Cross-Category Linking"

        [ "${ENABLE_USER_PERSONALIZATION:-false}" = "true" ] && \
            print_status $GREEN "  ‚úì User Personalization" || \
            print_status $YELLOW "  ‚óã User Personalization"
    else
        print_status $YELLOW "  (Enhancements disabled, set USE_ENHANCED_CLUSTERING=true to enable)"
    fi

    echo ""
    echo "Performance Tuning:"
    echo "  Batch Size: ${CLUSTER_BATCH_SIZE:-20}"
    echo "  Heat History Window: ${HEAT_HISTORY_WINDOW_HOURS:-48}h"
    echo "  Prediction Threshold: ${PREDICTION_CONFIDENCE_THRESHOLD:-0.3}"
    echo "  Anomaly Z-Score Threshold: ${ANOMALY_Z_SCORE_THRESHOLD:-3.0}"

    echo ""
    print_status $BLUE "üìä Enhancement Metrics:"
    echo "  For detailed metrics, visit the dashboard at:"
    print_status $GREEN "  http://0.0.0.0:3001/api/enhanced/news/anomalies"
    print_status $GREEN "  http://0.0.0.0:3001/api/enhanced/news/predictions"
    print_status $GREEN "  http://0.0.0.0:3001/api/enhanced/news/quality-metrics"
    print_status $GREEN "  http://0.0.0.0:3001/api/enhanced/news/entities/trending"
}

# Function to start services
start_services() {
    local services=("$@")
    if [ ${#services[@]} -eq 0 ]; then
        services=("perps-redis" "chromadb" "perps-dashboard" "perps-news" "perps-predictions" "perps-ingester" "perps-agent")
    fi
    
    for service in "${services[@]}"; do
        print_status $BLUE "üöÄ Starting $service..."
        sudo systemctl start "$service"
        if systemctl is-active --quiet "$service"; then
            print_status $GREEN "‚úÖ $service started successfully"
        else
            print_status $RED "‚ùå Failed to start $service"
        fi
    done
}

# Function to stop services
stop_services() {
    local services=("$@")
    if [ ${#services[@]} -eq 0 ]; then
        services=("perps-agent" "perps-ingester" "perps-predictions" "perps-news" "perps-dashboard" "chromadb" "perps-redis")
    fi
    
    for service in "${services[@]}"; do
        print_status $YELLOW "üõë Stopping $service..."
        sudo systemctl stop "$service"
        if ! systemctl is-active --quiet "$service"; then
            print_status $GREEN "‚úÖ $service stopped successfully"
        else
            print_status $RED "‚ùå Failed to stop $service"
        fi
    done
}

# Function to restart services
restart_services() {
    local services=("$@")
    if [ ${#services[@]} -eq 0 ]; then
        services=("perps-redis" "chromadb" "perps-dashboard" "perps-news" "perps-predictions" "perps-ingester" "perps-agent")
    fi
    
    for service in "${services[@]}"; do
        print_status $BLUE "üîÑ Restarting $service..."
        sudo systemctl restart "$service"
        sleep 2
        if systemctl is-active --quiet "$service"; then
            print_status $GREEN "‚úÖ $service restarted successfully"
        else
            print_status $RED "‚ùå Failed to restart $service"
        fi
    done
}

# Function to show logs
show_logs() {
    local service=${1:-"perps-agent"}
    print_status $BLUE "üìã Showing logs for $service (Ctrl+C to exit)..."
    journalctl -u "$service" -f
}

# Function to enable services on boot
enable_services() {
    local services=("$@")
    if [ ${#services[@]} -eq 0 ]; then
        services=("perps-agent" "perps-dashboard")
    fi
    
    for service in "${services[@]}"; do
        print_status $BLUE "üîß Enabling $service on boot..."
        sudo systemctl enable "$service"
        print_status $GREEN "‚úÖ $service enabled"
    done
}

# Function to disable services from boot
disable_services() {
    local services=("$@")
    if [ ${#services[@]} -eq 0 ]; then
        services=("perps-agent" "perps-dashboard")
    fi
    
    for service in "${services[@]}"; do
        print_status $YELLOW "üîß Disabling $service from boot..."
        sudo systemctl disable "$service"
        print_status $GREEN "‚úÖ $service disabled"
    done
}

# Function to emergency stop all trading
emergency_stop() {
    print_status $RED "üö® EMERGENCY STOP - Halting all trading!"
    sudo systemctl stop perps-agent perps-ingester perps-predictions perps-pumpfun perps-safekeeping
    print_status $GREEN "‚úÖ All trading services stopped"
}

# Function to update the system
update_system() {
    print_status $BLUE "üîÑ Updating PerpsTrader..."
    cd "$PROJECT_DIR"
    
    # Pull latest changes from current branch
    CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
    git pull origin "$CURRENT_BRANCH"
    
    # Install dependencies
    npm install
    
    # Build
    npm run build
    
    # Restart services
    restart_services
    
    print_status $GREEN "‚úÖ PerpsTrader updated successfully"
}

# Function to run operational health audit
run_health_audit() {
    print_status $BLUE "ü©∫ Running PerpsTrader health audit..."
    cd "$PROJECT_DIR"
    if [ -x "$PROJECT_DIR/scripts/health-audit.sh" ]; then
        "$PROJECT_DIR/scripts/health-audit.sh"
    else
        print_status $RED "‚ùå Health audit script not found: scripts/health-audit.sh"
        return 1
    fi
}

# Function to show help
show_help() {
    echo "PerpsTrader Control Script"
    echo "Usage: $0 [COMMAND] [OPTIONS]"
    echo ""
    echo "Commands:"
    echo "  status                    Show status of all services"
    echo "  health                    Run end-to-end operational health audit"
    echo "  enhanced                  Show enhanced clustering status and metrics"
    echo "  start [service...]         Start services (all if none specified)"
    echo "  stop [service...]          Stop services (all if none specified)"
    echo "  restart [service...]       Restart services (all if none specified)"
    echo "  logs [service]            Show logs for service (default: perps-agent)"
    echo "  enable [service...]        Enable services on boot (agent, dashboard if none)"
    echo "  disable [service...]       Disable services from boot (agent, dashboard if none)"
    echo "  emergency                 Emergency stop all trading"
    echo "  update                    Update PerpsTrader to latest version"
    echo "  help                     Show this help message"
    echo ""
    echo "Services:"
    echo "  perps-redis             Isolated Redis message bus"
    echo "  chromadb                Chroma vector store"
    echo "  perps-agent             Main AI trading agent"
    echo "  perps-ingester          Market data ingester"
    echo "  perps-news              News ingestion agent"
    echo "  perps-predictions       Prediction markets agent"
    echo "  perps-dashboard         Web dashboard"
    echo ""
    echo "Examples:"
    echo "  $0 status               # Show all service status"
    echo "  $0 enhanced             # Show enhanced clustering status"
    echo "  $0 start perps-agent    # Start only the agent"
    echo "  $0 logs perps-dashboard # Show dashboard logs"
    echo "  $0 emergency            # Emergency stop all trading"
}

# Main script logic
case "${1:-help}" in
    "status")
        show_status
        ;;
    "health")
        run_health_audit
        ;;
    "enhanced")
        show_enhanced_status
        ;;
    "start")
        start_services "${@:2}"
        ;;
    "stop")
        stop_services "${@:2}"
        ;;
    "restart")
        restart_services "${@:2}"
        ;;
    "logs")
        show_logs "${2:-perps-agent}"
        ;;
    "enable")
        enable_services "${@:2}"
        ;;
    "disable")
        disable_services "${@:2}"
        ;;
    "emergency")
        emergency_stop
        ;;
    "update")
        update_system
        ;;
    "help"|*)
        show_help
        ;;
esac
